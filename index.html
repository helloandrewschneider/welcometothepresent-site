
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Walk</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        background: black;
        color: #ccc;
        height: 100vh;
        overflow: hidden;
      }
      body {
        position: relative;
        top: -15vh; /* adjust as needed: -2vh, -5vh, etc. */
      }

      .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        transition: opacity 1.2s ease;
      }
      .hidden {
        opacity: 0;
        pointer-events: none;
        display: none;
      }
      h1 {
        font-weight: 300;
        font-size: 1em;
      }
      .circle-button-wrapper {
        position: relative;
        width: 100px;
        height: 100px;
        margin-top: 1.25em;
      }
      .rotating-ring {
        position: absolute;
        top: 0;
        left: 0;
        width: 100px;
        height: 100px;
        transform-origin: center;
        animation: rotateRing 60s linear infinite;
        pointer-events: none;
      }
      @keyframes rotateRing {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .start {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: none;
        outline: none;
        background: transparent;
        color: #ccc;
        font-size: 1em;
        font-weight: 300;
        text-shadow: 0 0 10px rgba(255,255,255,0.3);
        cursor: pointer;
        z-index: 2;
        position: relative;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }
      #question-text {
        font-size: 1em;
        font-family: 'Inter', sans-serif;
        margin-bottom: 1em;
      }
      #options {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
      }
      #options button {
        transition: transform 0.1s ease, box-shadow 0.4s ease, background 0.3s ease;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        font-size: 1em;
        background: transparent;
        border: 1px solid #ccc;
        color: #ccc;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Inter', sans-serif;
      }
      button {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        user-select: none;
        touch-action: manipulation;
      }
      .ellipsis {
        display: inline-block;
        white-space: nowrap;
      }
      .dot {
        opacity: 0;
        animation: blink 1.5s infinite;
        display: inline-block;
      }
      .dot1 { animation-delay: 0s; }
      .dot2 { animation-delay: 0.3s; }
      .dot3 { animation-delay: 0.6s; }

      @keyframes blink {
        0%, 20% { opacity: 1; }
        21%, 100% { opacity: 0; }
      }
      
      .glow {
        box-shadow: 0 0 15px rgba(255,255,255,0.6);
        transform: scale(0.95);
      }

      body.large-text h1,
        body.large-text #question-text,
        body.large-text button,
        body.large-text #options button {
          font-size: 2em !important;
        }  
      /*
      #toggle-text-size {
        position: absolute;
        top: calc(1em + 15vh);
        right: 1em;
        background: transparent;
        border: 1px solid #666;
        color: #ccc;
        padding: 0.3em 0.6em;
        font-size: 1em;
        z-index: 9999;
        cursor: pointer;
      }
      */
    @keyframes pulsingGlow {
    0% {
      box-shadow: 0 0 8px hsl(0, 70%, 70%);
      transform: scale(0.95);
    }
    25% {
      box-shadow: 0 0 15px hsl(90, 70%, 70%);
      transform: scale(1.04);
    }
    50% {
      box-shadow: 0 0 8px hsl(180, 70%, 70%);
      transform: scale(0.95);
    }
    75% {
      box-shadow: 0 0 15px hsl(270, 70%, 70%);
      transform: scale(1.04);
    }
    100% {
      box-shadow: 0 0 8px hsl(360, 70%, 70%);
      transform: scale(0.95);
    }
  }

  .start.glowing {
    animation: pulsingGlow 6s ease-in-out infinite;
  }
  .start.fading-glow {
    animation: none;
    transition: box-shadow 1s ease;
    box-shadow: 0 0 0 rgba(255, 255, 255, 0); /* fade to nothing */
  }

  .onboarding-option {
    transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.3s ease; color 1.2s ease, border-color 1.2s ease;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    font-size: 1em;
    background: transparent;
    border: 1px solid #ccc;
    color: #ccc;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Inter', sans-serif;
  }

  #audio-screen canvas {
    width: 100vw;
    display: block;
  }
  .fade-overlay {
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    width: 100vw;
    height: calc(100vh / 1.5);
    pointer-events: none;
    background: linear-gradient(to right, black 0%, transparent 10%, transparent 90%, black 100%);
    z-index: 1;
  }

  #audio-screen {
    position: relative;
    top: 15vh; /* cancels out the body's -15vh */
  }

  .fade-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100vw;
    height: 200px;
    pointer-events: none;
    background: linear-gradient(to top, black 0%, transparent 100%);
    z-index: 1;
  }


    </style>
  </head>
  <body>
    <!-- <button id="toggle-text-size" onclick="document.body.classList.toggle('large-text')">A+</button> -->
    <div id="splash" class="screen">
      <h1>
        <div style="margin: 1.25em 0;">welcome</div>
        <div style="margin: 1.25em 0;">to</div>
        <div style="margin: 1.25em 0;">the</div>
      </h1>
      <div class="circle-button-wrapper">
        <svg class="rotating-ring" viewBox="0 0 100 100" width="100" height="100">
          <circle cx="50" cy="50" r="48" fill="none" stroke="#ccc" stroke-width="2" stroke-dasharray="2,4" />
        </svg>
        <button class="start" onclick="startQuestions()">present</button>
      </div>
    </div>

    <div id="onboarding1" class="screen hidden">
    <h1>
      <div id="headphones-line1">This project is best experienced using your headphones.</div>
      <div id="headphones-line2" style="margin-top: 1em; opacity: 0; transition: opacity 1.2s ease;">
        Are you wearing headphones?
      </div>
    </h1>
  <div id="headphones-buttons" style="opacity: 0; transition: opacity 1.2s ease; margin-top: 2em; display: flex; flex-direction: row; justify-content: center; gap: 20px;">
    <button class="onboarding-option" onclick="triggerOnboardingGlow(this, true)">Yes, let's test</button>
    <button class="onboarding-option" onclick="triggerOnboardingGlow(this, false)">No, I'll go get some</button>
  </div>
  <div id="headphones-wait-timer" style="opacity: 0; transition: opacity 0.5s ease; margin-top: 2em;">
    <svg width="60" height="60" viewBox="0 0 100 100">
      <circle cx="50" cy="50" r="45" stroke="#888" stroke-width="5" fill="none" opacity="0.3"/>
      <circle id="headphones-progress-ring" cx="50" cy="50" r="45" stroke="#ccc" stroke-width="5" fill="none"
      stroke-dasharray="282.6" stroke-dashoffset="0" stroke-linecap="round"
      style="transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 1s linear;" />
    </svg>
  </div>


  </div>


    <div id="onboarding2" class="screen hidden">
      <h1>
        <div>Move slowly and stay aware</div>
        <div style="margin-top: 1em;">This experience blends sound with your world</div>
      </h1>
    </div>

    <div id="headphone-test" class="screen hidden">
      <h1 id="test-instructions" style="color: #ccc; transition: color 1.2s ease;">
      <div>To test your headphones</div>
      <div style="margin-top: 1em;">Click in the circles below</div>
      </h1>

      <div id="test-buttons" style="display: flex; gap: 20px; margin-top: 2em;">
        <button class="onboarding-option" onclick="testHeadphone('left', this)">Left</button>
        <button class="onboarding-option" onclick="testHeadphone('right', this)">Right</button>
      </div>
      
      <div id="test-confirmation" style="opacity: 0; transition: opacity 1.2s ease; margin-top: 2em;">
        <div>Do you hear the sounds in each ear?</div>
        <div style="margin-top: 1em; font-size: 0.9em; color: #888;">
          (you may need to adjust your volume to hear the test at a comfortable level)
        </div>
      </div>

      <div id="test-actions" style="opacity: 0; transition: opacity 1.2s ease; margin-top: 2em; display: flex; gap: 20px;">
        <button class="onboarding-option" onclick="continueFromTest()">Yes, let's go</button>
        <button class="onboarding-option" onclick="retryHeadphoneTest()">No, I'll keep trying</button>
      </div>

      <div id="wait-timer" style="opacity: 0; transition: opacity 0.5s ease; margin-top: 2em;">
        <svg width="60" height="60" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="45" stroke="#888" stroke-width="5" fill="none" opacity="0.3"/>
          <circle id="progress-ring" cx="50" cy="50" r="45" stroke="#ccc" stroke-width="5" fill="none"
          stroke-dasharray="282.6" stroke-dashoffset="0" stroke-linecap="round"
          style="transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 1s linear;" />
        </svg>
      </div>

    </div>


    <div id="intro" class="screen hidden">
      <h1>
        <div>Just a few questions,</div> 
        <div style="margin-top: 1em;">to give you the best experience that we can <span class="ellipsis"><span class="dot dot1">.</span><span class="dot dot2">.</span><span class="dot dot3">.</span></span></div>
      </h1>
    </div>

    <div id="question-screen" class="screen hidden">
      <div id="question-text"></div>
      <div id="options"></div>
    </div>

  <div id="audio-screen" class="screen hidden">
    <canvas id="waveCanvas"></canvas>
    <div class="fade-overlay"></div>
    <div class="fade-bottom"></div>
  </div>



    <audio id="audio-player" autoplay></audio>

  <audio id="waiting-music" src="https://audio.welcometothepresent.com/waiting-music.mp3" preload="auto"></audio>


    <script>
      let audioCtx;
      let sharedGain;

      const questions = [
    { text: "Are you currently indoors or outdoors?", options: ["Indoors", "Outdoors"] },
    { text: "Is it day or night?", options: ["Day", "Night"] },
    { text: "Are you in a quiet or loud environment?", options: ["Quiet", "Loud"] },
    { text: "Are you an animal?", options: ["Yes", "No"] },
    { text: "Is the best moment of your life ahead of you or behind you?", options: ["Ahead", "Behind"] },
    { text: "Mountains or Ocean?", options: ["Mountains", "Ocean"] },
    { text: "If you could stop time once in your life would you have done it already, or would you still be saving it?", options: ["Used it", "Saving it"] },
    { text: "Have you ever been anyone else?", options: ["Yes", "No", "Maybe"] },
    { text: "Will you ever be here again?", options: ["Yes", "No"] },
    { text: "Do you end?", options: ["Yes", "No"] },
    { text: "What happens next?", options: ["An egg cracks", "Silence"] },
    { text: "How do you let go?", options: ["Gently", "Loudly"] },
    { text: "Where do you find hope?", options: ["In a sock drawer", "Beneath asphalt"] },
    { text: "What are you not doing right now?", options: ["Ballet", "Eating cheese"] },
    { text: "Who do you know?", options: ["A shadow", "An old shoelace"] },
    { text: "What are you asking yourself recently?", options: ["Why not", "Why now"] },
    { text: "Do you still do things for the same reasons?", options: ["Yes, reluctantly", "No, chaotically"] },
    { text: "What thrills you?", options: ["Spinning", "Pausing"] },
    { text: "When do you know?", options: ["Right before", "Right after"] },
    { text: "What do you do with regret?", options: ["Fold it into paper", "Eat it"] },
    { text: "How did it go?", options: ["It never started", "It ended twice"] },
    { text: "What do you miss?", options: ["The smell of crayons", "Your imaginary friend"] },
    { text: "When do you want to leave?", options: ["Midway", "At the applause"] },
    { text: "What do you want to change?", options: ["The sky’s flavor", "Nothing"] },
    { text: "What do you want to stay?", options: ["The hum", "The socks"] },
    { text: "Are you the same person you were five years ago?", options: ["Yes, but squishier", "No, I’ve evaporated"] },
    { text: "When are you in chaos?", options: ["During silence", "After tea"] },
    { text: "Describe what happens when you daydream", options: ["Time folds", "Pencils float"] },
    { text: "What is something that you don’t know?", options: ["The rules", "The ending"] },
    { text: "What’s your story?", options: ["I forgot", "Still writing"] },
    { text: "What do you want to be when you grow up?", options: ["A balloon", "A philosopher"] },
    { text: "What is your dream?", options: ["Weightlessness", "A doorway"] },
    { text: "What are you doing?", options: ["Becoming", "Repeating"] },
    { text: "What are you inside of?", options: ["A loop", "A cloud"] },
        /* the start of GPT generated questions */
  { text: "What color is silence?", options: ["Blue", "Clear"] },
  { text: "Where does memory live?", options: ["In your elbow", "In a hallway"] },
  { text: "What do you carry?", options: ["A glimmer", "A glitch"] },
  { text: "What have you almost said?", options: ["Everything", "Nothing"] },
  { text: "What shape is your breath?", options: ["Spiral", "Square"] },
  { text: "When do you feel most real?", options: ["When laughing", "When alone"] },
  { text: "What are you waiting for?", options: ["A knock", "A breeze"] },
  { text: "What hides beneath your calm?", options: ["Thunder", "A song"] },
  { text: "How do you arrive?", options: ["Suddenly", "Gradually"] },
  { text: "Who whispers to you?", options: ["Your future self", "The wind"] },
  { text: "What isn’t yours but feels like it is?", options: ["A dream", "A mistake"] },
  { text: "What have you left behind?", options: ["A scent", "A sentence"] },
  { text: "What still echoes?", options: ["Footsteps", "Your name"] },
  { text: "What color is time?", options: ["Amber", "Silver"] },
  { text: "Where do you vanish to?", options: ["Between blinks", "Under the bed"] },
  { text: "What’s been waiting for you?", options: ["A question", "A corner"] },
  { text: "What moves too slowly?", options: ["Forgiveness", "Traffic"] },
  { text: "What’s broken but still working?", options: ["A compass", "A promise"] },
  { text: "What grows in the dark?", options: ["Moss", "Secrets"] },
  { text: "When do you remember?", options: ["Before sleep", "Mid-step"] },

  ];
      const responses = [];
      let currentQuestion = 0;

      function fadeIn(id) {
    const el = document.getElementById(id);
    el.classList.remove('hidden');
    el.style.display = 'flex';
    el.style.opacity = '0';

    // Ensure opacity transition applies AFTER display change
    setTimeout(() => {
      el.style.opacity = '1';
    }, 30); // 30ms is usually enough to trigger transition
  }


      function fadeOut(id, callback) {
        const el = document.getElementById(id);
        el.style.opacity = '0';
        setTimeout(() => {
          el.classList.add('hidden');
          el.style.display = 'none';
          if (callback) callback();
        }, 1200);
      }

      function fadeOutCustom(id, duration, callback) {
        const el = document.getElementById(id);
        el.style.opacity = '0';
        setTimeout(() => {
          el.classList.add('hidden');
          el.style.display = 'none';
          if (callback) callback();
        }, duration);
      }
      
  function startQuestions() {
    const startButton = document.querySelector('.start');

    // Freeze current glow style
    const computedStyle = window.getComputedStyle(startButton);
    const currentShadow = computedStyle.getPropertyValue('box-shadow');
    startButton.style.boxShadow = currentShadow;
    startButton.classList.remove('glowing');
    startButton.classList.add('fading-glow');

    setTimeout(() => {
      startButton.classList.remove('fading-glow');
      startButton.style.boxShadow = '';
    }, 1000);

    document.querySelector('.rotating-ring').classList.add('fade-glow');

    // Initialize audio context
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sharedGain = audioCtx.createGain();
    sharedGain.connect(audioCtx.destination);

    // Fade out splash, then go fullscreen
    fadeOut('splash', () => {
      const fade = document.getElementById('fullscreen-fade');
      fade.style.opacity = '1';

      setTimeout(() => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          elem.msRequestFullscreen();
        }

        fade.style.opacity = '0';

            // Continue with onboarding after fullscreen
  fadeIn('onboarding1');

  // Show second line and buttons after a pause
  setTimeout(() => {
    document.getElementById('headphones-line2').style.opacity = '1';
  document.getElementById('headphones-buttons').style.opacity = '1';
  }, 5000); // adjust this delay if needed



      }, 1500); // fullscreen transition delay
    });
  }




      function showQuestion() {
        const question = questions[currentQuestion];
        document.getElementById('question-text').innerText = question.text;
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';

        question.options.forEach(option => {
          const btn = document.createElement('button');
          btn.textContent = option;
          btn.onclick = () => {
            if (navigator.vibrate) navigator.vibrate(10);
            playTone(currentQuestion);
            /* old glow - replaced with dynamic HSL glow
            btn.classList.add('glow');
            setTimeout(() => {
              btn.classList.remove('glow');
            }, 500);
            */
            /* --- new HSL glow below ---*/
            const hue = Math.floor(Math.random() * 360);
              const color = `hsl(${hue}, 70%, 70%)`;
              btn.style.boxShadow = `0 0 15px ${color}`;
              btn.style.transform = 'scale(0.95)';
              
              setTimeout(() => {
                btn.style.boxShadow = '';
                btn.style.transform = '';
              }, 500);
            /* ------------------------- */
            responses.push(option);
            playTone(currentQuestion);
            fadeOut('question-screen', () => {
              currentQuestion++;
              if (currentQuestion === 4) {
              playAudio(); // kicks off autopilot
            }
            if (currentQuestion < questions.length) {
              fadeIn('question-screen');
              showQuestion();
            } else {
              fadeIn('audio-screen');
              //initWaveCanvas();
            }

            });
          };
          optionsDiv.appendChild(btn);
        });
      }

      function playAudio() {
    const audio = document.getElementById('audio-player');
    audio.src = 'https://audio.welcometothepresent.com/PRESENT-20250802-THEREHEARSAL-scratch03.mp3';
    audio.play();
    setTimeout(beginAutoQuestions, 55500);
  }

      function beginAutoQuestions() {
        let interval = 2500;
        let acceleration = 0.85;
        let autoStepCount = 0;
        let fadeTime = 500;

        function step() {
          if (currentQuestion >= questions.length) return;

          setTimeout(() => {
            const question = questions[currentQuestion];
            const choice = question.options[Math.floor(Math.random() * question.options.length)];
            const buttons = document.querySelectorAll('#options button');
          buttons.forEach(btn => {
            if (btn.textContent === choice) {
      /* old glow - replaced with dynamic HSL glow        
        btn.classList.add('glow');
              playTone(currentQuestion);
          setTimeout(() => {
            btn.classList.remove('glow');
      }, 500);
      */
      /* --- new HSL glow below ---*/
            const hue = Math.floor(Math.random() * 360);
              const color = `hsl(${hue}, 70%, 70%)`;
              btn.style.boxShadow = `0 0 15px ${color}`;
              btn.style.transform = 'scale(0.95)';
              playTone(currentQuestion);
              
              setTimeout(() => {
                btn.style.boxShadow = '';
                btn.style.transform = '';
              }, 500);
        /* -------------------------*/

    }
  });

  const visibilityDelay = Math.min(600, interval * 0.6); // calculate how long to wait before fading

  setTimeout(() => {
    fadeOutCustom('question-screen', fadeTime, () => {
      responses.push(choice);
      currentQuestion++;
      if (currentQuestion < questions.length) {
        fadeIn('question-screen');
        showQuestion();
        step();
      } else {
        fadeIn('audio-screen');
        //initWaveCanvas();
      }
    });
  }, visibilityDelay);

          }, interval);

          interval *= acceleration;
            fadeTime *= 0.9;
            if (fadeTime < 100) fadeTime = 100;
            if (currentQuestion >= 20) fadeTime = 50;

        }

        step();
      }
    function playTone(index) {
    if (!audioCtx) return;

    const oscillator = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    oscillator.type = 'sine';
    oscillator.frequency.value = index % 2 === 0 ? 440 : 220;

    oscillator.connect(gain);
    gain.connect(sharedGain);
    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5);
  }

  window.addEventListener('load', () => {
    document.querySelector('.start').classList.add('glowing');
  });

  function onboarding1Response(isReady) {
    fadeOut('onboarding1', () => {
      setTimeout(() => {
        if (isReady) {
          // Go to headphone test screen
          fadeIn('headphone-test');
          // Reset headphone test state after fade-in begins
    requestAnimationFrame(() => {
      leftClicked = false;
      rightClicked = false;
      document.getElementById('test-confirmation').style.opacity = '0';
    });

        } else {
          // Continue with onboarding2 as normal
          fadeIn('onboarding2');
          setTimeout(() => {
            fadeOut('onboarding2', () => {
              setTimeout(() => {
                fadeIn('intro');
                setTimeout(() => {
                  fadeOut('intro', () => {
                    fadeIn('question-screen');
                    showQuestion();
                  });
                }, 5000);
              }, 300);
            });
          }, 5000);
        }
      }, 300);
    });
  }


  let leftClicked = false;
  let rightClicked = false;

  function testHeadphone(side, btn) {
    // Glow effect (same as question buttons)
    const hue = Math.floor(Math.random() * 360);
    const color = `hsl(${hue}, 70%, 70%)`;
    btn.style.boxShadow = `0 0 15px ${color}`;
    btn.style.transform = 'scale(0.95)';

    setTimeout(() => {
      btn.style.boxShadow = '';
      btn.style.transform = '';
    }, 500);

    // Play test tone to appropriate channel
    playTestTone(side);

    // Track whether both buttons have been clicked
    if (side === 'left') leftClicked = true;
    if (side === 'right') rightClicked = true;

    if (leftClicked && rightClicked) {
    document.getElementById('test-confirmation').style.opacity = '1';
    document.getElementById('test-actions').style.opacity = '1';
    document.getElementById('test-instructions').style.color = '#555';

    const testButtons = document.querySelectorAll('#test-buttons .onboarding-option');
    testButtons.forEach(btn => {
      btn.style.color = '#555';
      btn.style.borderColor = '#555';
    });
  }

  }

  function playTestTone(side) {
    if (!audioCtx) return;

    const oscillator = audioCtx.createOscillator();
    const panNode = audioCtx.createStereoPanner();
    const gain = audioCtx.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.value = side === 'left' ? 440 : 220;
    panNode.pan.value = side === 'left' ? -1 : 1;

    oscillator.connect(panNode);
    panNode.connect(gain);
    gain.connect(sharedGain);

    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5);
  }


  function triggerOnboardingGlow(button, isReady) {
    const hue = Math.floor(Math.random() * 360);
    const color = `hsl(${hue}, 70%, 70%)`;
    button.style.boxShadow = `0 0 15px ${color}`;
    button.style.transform = 'scale(0.95)';

    setTimeout(() => {
      button.style.boxShadow = '';
      button.style.transform = '';
      
      if (isReady) {
        onboarding1Response(true); // "Yes, let's test"
      } else {
        goGetHeadphones(); // "No, I’ll go get some"
      }
    }, 500);
  }


  function continueFromTest() {
    fadeOut('headphone-test', () => {
      setTimeout(() => {
        fadeIn('onboarding2');
        setTimeout(() => {
          fadeOut('onboarding2', () => {
            setTimeout(() => {
              fadeIn('intro');
              setTimeout(() => {
                fadeOut('intro', () => {
                  fadeIn('question-screen');
                  showQuestion();
                });
              }, 5000);
            }, 300);
          });
        }, 5000);
      }, 300);
    });
  }

  function retryHeadphoneTest() {
    document.getElementById('test-confirmation').style.opacity = '0';
    document.getElementById('test-actions').style.opacity = '0';
    document.getElementById('test-instructions').style.color = '#ccc';

    const testButtons = document.querySelectorAll('#test-buttons .onboarding-option');
    testButtons.forEach(btn => {
      btn.disabled = false;
      btn.style.color = '#ccc';
      btn.style.borderColor = '#ccc';
      btn.style.cursor = 'pointer';
    });

    leftClicked = false;
    rightClicked = false;
  }

  function goGetHeadphones() {
    const line1 = document.getElementById('headphones-line1');
    const line2 = document.getElementById('headphones-line2');
    const buttons = document.querySelectorAll('#headphones-buttons .onboarding-option');
    const timer = document.getElementById('headphones-wait-timer');
    const ring = document.getElementById('headphones-progress-ring');
    const music = document.getElementById('waiting-music');

    // Grey out lines and disable buttons
    line1.style.color = '#555';
    line2.style.color = '#555';
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.color = '#555';
      btn.style.borderColor = '#555';
      btn.style.cursor = 'not-allowed';
    });

    // Show timer
    ring.style.strokeDashoffset = 0;
    timer.style.opacity = '1';

    // Play music
    music.currentTime = 0;
    music.volume = 0.1; // volume from 0.0 (silent) to 1.0 (full volume)
    music.play();

    // Timer logic
    let timeLeft = 15;
    const totalLength = 2 * Math.PI * 45;
    const interval = setInterval(() => {
      timeLeft--;
      ring.style.strokeDashoffset = totalLength * (1 - timeLeft / 15);

      if (timeLeft <= 0) {
        clearInterval(interval);

        // Reset visuals
        timer.style.opacity = '0';
        music.pause();

        line1.style.color = '#ccc';
        line2.style.color = '#ccc';
        buttons.forEach(btn => {
          btn.disabled = false;
          btn.style.color = '#ccc';
          btn.style.borderColor = '#ccc';
          btn.style.cursor = 'pointer';
        });
      }
    }, 1000);
  }

  /* OLD WHITE SINE WAVE*/
  /*
  let canvas, ctx;
  function initWaveCanvas() {
    canvas = document.getElementById('waveCanvas');
    if (!canvas) return;
    ctx = canvas.getContext('2d');

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight / 1.5;
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let offset = 0;
    let visibleLength = 0;

    function drawSineWave() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const amplitude = canvas.height / 2 - 8;
      const wavelength = 80;
      const centerY = canvas.height / 2;

      let prevX = 0;
      let prevY = centerY + Math.sin((prevX + offset) / wavelength) * amplitude;

      if (visibleLength < canvas.width) {
        visibleLength += 10;
      } else {
        visibleLength = canvas.width;
      }

      for (let x = 1; x <= visibleLength; x++) {
        const localWavelength = wavelength + Math.sin((x + offset) / 200) * 20;
        const y = centerY + Math.sin((x + offset) / localWavelength) * amplitude;

        const pressure = Math.abs(Math.cos((x + offset) / 100));
        ctx.lineWidth = 1 + pressure * 4;

        ctx.beginPath();
        ctx.strokeStyle = '#ccc';
        ctx.moveTo(prevX, prevY);
        ctx.lineTo(x, y);
        ctx.stroke();

        prevX = x;
        prevY = y;
      }

      offset += 0.5;
      requestAnimationFrame(drawSineWave);
    }

    drawSineWave();
  }
  */

  </script>

  <script>
    const canvas = document.getElementById('waveCanvas');
    const ctx = canvas.getContext('2d');

    let width = window.innerWidth;
    let height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;

    const startY = 100;
    const trail = new Array(height - startY).fill(width / 2);
    const lineWidths = new Array(height - startY).fill(2);
    const hueTrail = new Array(height - startY).fill(0);

    let t = 0;
    let baseFrequency = 0.005;
    let baseAmplitude = width * 0.2;
    let targetFrequency = baseFrequency;
    let targetAmplitude = baseAmplitude;
    let freqStep = 0;
    let ampStep = 0;
    let steps = 300;
    let stepCount = 0;
    let currentLineWidth = 4;
    let targetLineWidth = 4;
    let lineWidthStep = 0;
    let lineWidthSteps = 100;
    let lineWidthStepCount = 0;
    let hue = 0;
    const circleRadius = 6;

    function setNewTargets() {
      const newTargetFrequency = 0.003 + Math.random() * 0.004;
      const newTargetAmplitude = width * (0.1 + Math.random() * 0.2);
      freqStep = (newTargetFrequency - baseFrequency) / steps;
      ampStep = (newTargetAmplitude - baseAmplitude) / steps;
      targetFrequency = newTargetFrequency;
      targetAmplitude = newTargetAmplitude;
      stepCount = 0;
    }

    function setNewLineWidthTarget() {
      targetLineWidth = 2 + Math.random() * 10;
      lineWidthStep = (targetLineWidth - currentLineWidth) / lineWidthSteps;
      lineWidthStepCount = 0;
    }

    function drawFeatheredOverlay() {
      const featherHeight = 150;
      const gradient = ctx.createLinearGradient(0, height - featherHeight, 0, height);
      gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
      gradient.addColorStop(1, 'rgba(255, 0, 0, 0.85)');

      ctx.fillStyle = gradient;
      ctx.fillRect(0, height - featherHeight, width, featherHeight);
    }

    function animate() {
      requestAnimationFrame(animate);

      if (stepCount < steps) {
        baseFrequency += freqStep;
        baseAmplitude += ampStep;
        stepCount++;
      } else {
        setNewTargets();
      }

      if (lineWidthStepCount < lineWidthSteps) {
        currentLineWidth += lineWidthStep;
        lineWidthStepCount++;
      } else {
        setNewLineWidthTarget();
      }

      const x = width / 2 + Math.sin(t * baseFrequency) * baseAmplitude;
      t++;
      hue = (hue + 0.1) % 360;

      const previousX = trail[0];
      const smoothedX = previousX + (x - previousX) * 0.05;

      trail.pop();
      trail.unshift(smoothedX);
      hueTrail.pop();
      hueTrail.unshift(hue);
      lineWidths.pop();
      lineWidths.unshift(currentLineWidth);

      ctx.clearRect(0, 0, width, height);

      for (let i = 1; i < trail.length - 1; i++) {
        const y0 = startY + i;
        const x0 = trail[i];
        const y1 = startY + i - 1;
        const x1 = trail[i - 1];

        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.strokeStyle = `hsl(${hueTrail[i] % 360}, 100%, 75%)`;
        ctx.lineWidth = lineWidths[i];
        ctx.lineCap = 'round';
        ctx.setLineDash([]);
        ctx.stroke();
      }

      const circleY = startY;
      const circleX = trail[0];
      const glowIntensity = 0.6 + 0.4 * Math.sin(t * 0.1);

      ctx.shadowColor = `hsl(${hue}, 100%, 75%)`;
      ctx.shadowBlur = 30 * glowIntensity;

      ctx.beginPath();
      ctx.arc(circleX, circleY, circleRadius, 0, Math.PI * 2);
      ctx.fillStyle = `hsl(${hue}, 100%, 75%)`;
      ctx.fill();

      ctx.shadowBlur = 0;
      drawFeatheredOverlay();
    }

    setNewTargets();
    setNewLineWidthTarget();
    animate();

    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
      trail.length = height - startY;
      trail.fill(width / 2);
      lineWidths.length = height - startY;
      lineWidths.fill(currentLineWidth);
      hueTrail.length = height - startY;
      hueTrail.fill(hue);
      baseAmplitude = width * 0.2;
      setNewTargets();
      setNewLineWidthTarget();
    });
  </script>


  <div id="fullscreen-fade" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      opacity: 0;
      pointer-events: none;
      transition: opacity 3s ease;
      z-index: 9999;
    "></div>

  </body>
  </html>
