<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Synced Audio NTP</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="module" src="ntp.js"></script>
</head>
<body>
  <h1>Welcome to the Present</h1>
  <p id="status">Tap the button to begin</p>
  <button id="startBtn">ðŸ”Š Begin</button>
  <button id="playBtn" disabled style="display:none;">ðŸ”Š Waiting to sync...</button>

  <audio id="audio" src="https://audio.welcometothepresent.com/waiting-music.mp3" preload="auto"></audio>

  <script type="module">
    import { estimateClockOffset } from './ntp.js';

    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const syncBtn = document.getElementById('playBtn');
    const audio = document.getElementById('audio');

    let socket = null;
    let clockOffset = 0;
    let localReady = false;
    let hasConnected = false;
    let readyBtn = null;

    function initSocket() {
      if (hasConnected || socket) return;

      console.log("ðŸ“¡ Initializing socketâ€¦");
      hasConnected = true;

      socket = io("https://impulse-backend.fly.dev", {
        transports: ["websocket"]
      });

      socket.on('connect', async () => {
        status.textContent = 'Calibrating clockâ€¦';
        clockOffset = await estimateClockOffset(socket);
        if (!status.textContent.includes("Partner found")) {
          status.textContent = 'Waiting for a partnerâ€¦';
        }
      });

      socket.on('status', (msg) => {
        console.log("[socket] status:", msg);
        status.textContent = msg;
        if (msg.includes('Partner found')) {
          showReadyButton();
        }
      });

      socket.on('start', (serverStartTime, delayMs) => {
        const clientStartTime = serverStartTime - clockOffset;
        const wait = clientStartTime - Date.now();

        console.log("[socket] start:", serverStartTime, "in", wait, "ms");
        status.textContent = `Starting in ${(wait / 1000).toFixed(1)}sâ€¦`;
        if (readyBtn) {
          readyBtn.textContent = "Starting...";
        }

        setTimeout(() => {
          if (localReady) {
            audio.currentTime = 0;
            audio.play();
            status.textContent = 'ðŸŽ¶ Playing now';
          } else {
            status.textContent = 'ðŸŽµ Countdown started, but you havenâ€™t clicked ready.';
          }
          if (readyBtn) {
            readyBtn.remove();
            readyBtn = null;
          }
        }, wait);
      });

      socket.onAny((event, ...args) => {
        console.log(`[socket] ${event}`, ...args);
      });
    }

    function showReadyButton() {
      readyBtn = document.createElement('button');
      readyBtn.textContent = "Yes, I'm ready";
      readyBtn.style.marginTop = "1em";
      readyBtn.onclick = () => {
        localReady = true;
        socket.emit('ready');
        readyBtn.disabled = true;
        readyBtn.textContent = "Waiting for your partner...";
      };
      document.body.appendChild(readyBtn);
    }

    startBtn.addEventListener('click', () => {
      startBtn.remove();
      initSocket();
    });
  </script>
</body>
</html>
