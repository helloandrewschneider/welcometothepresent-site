<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Synced Audio NTP</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="module" src="ntp.js"></script>
</head>
<body>
  <h1>Welcome to the Present</h1>
  <p id="status">Connectingâ€¦</p>
  <button id="playBtn" disabled>ðŸ”Š Waiting to sync...</button>

  <audio id="audio" src="https://audio.welcometothepresent.com/waiting-music.mp3" preload="auto"></audio>

  <script type="module">
    import { estimateClockOffset } from './ntp.js';

    const socket = io("https://impulse-backend.fly.dev", {
      transports: ["websocket"]
    });

    const status = document.getElementById('status');
    const button = document.getElementById('playBtn');
    const audio = document.getElementById('audio');
    let clockOffset = 0;
    let localReady = false;

    socket.on('connect', async () => {
      status.textContent = 'Calibrating clockâ€¦';
      clockOffset = await estimateClockOffset(socket);
      status.textContent = 'Waiting for a partnerâ€¦';
    });

    socket.on('status', (msg) => {
      status.textContent = msg;
      if (msg.includes('Partner found')) {
        showReadyButton();
      }
    });

    socket.on('start', (serverStartTime, delayMs) => {
      const clientStartTime = serverStartTime - clockOffset;
      const wait = clientStartTime - Date.now();

      status.textContent = `Starting in ${(wait / 1000).toFixed(1)}sâ€¦`;
      button.disabled = false;

      setTimeout(() => {
        if (localReady) {
          audio.currentTime = 0;
          audio.play();
          status.textContent = 'ðŸŽ¶ Playing now';
        } else {
          status.textContent = 'ðŸŽµ Countdown started, but you havenâ€™t clicked ready.';
        }
      }, wait);
    });

    function showReadyButton() {
      const btn = document.createElement('button');
      btn.textContent = "Yes, I'm ready";
      btn.style.marginTop = "1em";
      btn.onclick = () => {
        socket.emit('ready');
        localReady = true;
        btn.disabled = true;
        btn.textContent = "Waiting for your partner...";
      };
      document.body.appendChild(btn);
    }
  </script>
</body>
</html>
