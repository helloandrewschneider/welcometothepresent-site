<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Synced Audio NTP</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="module" src="ntp.js"></script>
</head>
<body>
  <h1>Welcome to the Present</h1>
  <p id="status">Tap the button to begin</p>
  <button id="startBtn">üîä Begin</button>

  <script type="module">
    import { estimateClockOffset } from './ntp.js';

    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');

    let socket = null;
    let clockOffset = 0;
    let localReady = false;
    let hasConnected = false;
    let audioBuffer = null;
    let context = null;
    let readyBtn = null;

    function initAudioContext() {
      context = new (window.AudioContext || window.webkitAudioContext)();
      return context;
    }

    async function loadAudio(url) {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      return context.decodeAudioData(arrayBuffer);
    }

    function scheduleAudio(startTime) {
      const source = context.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(context.destination);
      const delay = (startTime - Date.now()) / 1000;
      source.start(context.currentTime + delay);
      status.textContent = 'üé∂ Playing now';

      if (readyBtn) {
        readyBtn.remove();
        readyBtn = null;
      }

      setTimeout(() => {
        const syncPrompt = document.createElement('p');
        syncPrompt.innerHTML = "Did the audio start in sync?";
        const yes = document.createElement('button');
        yes.textContent = "‚úÖ Yes";
        const no = document.createElement('button');
        no.textContent = "‚ùå No";
        no.onclick = () => location.reload();
        yes.onclick = () => {
          yes.remove();
          no.remove();
          syncPrompt.remove();
        };
        document.body.append(syncPrompt, yes, no);
      }, source.buffer.duration * 1000);
    }

    function initSocket() {
      if (hasConnected || socket) return;
      hasConnected = true;

      socket = io("https://impulse-backend.fly.dev", {
        transports: ["websocket"]
      });

      socket.on('connect', async () => {
        status.textContent = 'Calibrating clock‚Ä¶';
        clockOffset = await estimateClockOffset(socket);
        if (!status.textContent.includes("Partner found")) {
          status.textContent = 'Waiting for a partner‚Ä¶';
        }
      });

      socket.on('status', (msg) => {
        console.log("[socket] status:", msg);
        status.textContent = msg;
        if (msg.includes('Partner found')) {
          showReadyButton();
        }
      });

      socket.on('start', async (serverStartTime, delayMs) => {
        const clientStartTime = serverStartTime - clockOffset;
        status.textContent = `Starting in ${((clientStartTime - Date.now()) / 1000).toFixed(1)}s‚Ä¶`;

        if (readyBtn) {
          readyBtn.textContent = "Starting‚Ä¶";
        }

        context.resume().then(() => {
          if (localReady && audioBuffer) {
            scheduleAudio(clientStartTime);
          } else {
            showManualPlayOption();
          }
        });
      });

      socket.onAny((event, ...args) => {
        console.log(`[socket] ${event}`, ...args);
      });
    }

    function showReadyButton() {
      readyBtn = document.createElement('button');
      readyBtn.textContent = "Yes, I'm ready";
      readyBtn.style.marginTop = "1em";
      readyBtn.onclick = () => {
        localReady = true;
        socket.emit('ready');
        readyBtn.disabled = true;
        readyBtn.textContent = "Waiting for your partner...";
      };
      document.body.appendChild(readyBtn);
    }

    function showManualPlayOption() {
      const fallback = document.createElement('button');
      fallback.textContent = "üîÑ Tap to start audio";
      fallback.onclick = () => {
        if (audioBuffer) {
          scheduleAudio(Date.now());
          fallback.remove();
        }
      };
      document.body.appendChild(fallback);
    }

    startBtn.addEventListener('click', async () => {
      startBtn.remove();
      context = initAudioContext();
      try {
        audioBuffer = await loadAudio("https://audio-cors-proxy.helloandrewschneider.workers.dev/waiting-music.mp3");
      } catch (e) {
        status.textContent = "‚ö†Ô∏è Failed to load audio.";
        return;
      }
      initSocket();
    });
  </script>
</body>
</html>
